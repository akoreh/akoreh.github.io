import{a as $,c as K,e as z}from"./chunk-BSBTI4CD.js";import{b as W}from"./chunk-ZNY4EBEK.js";import{a as V}from"./chunk-PWOPK7WU.js";import{c as O}from"./chunk-WV23WNJS.js";import"./chunk-43QEPZZV.js";import"./chunk-2W377MUZ.js";import{a as q}from"./chunk-N7A2IJBE.js";import"./chunk-VLPVFQJS.js";import{Ab as B,Cb as p,Ia as l,Kb as H,L as C,Mb as s,Ob as u,Pb as S,Qb as M,R as N,Rb as L,Yb as x,Z as R,Za as P,Zb as _,_b as E,ab as h,da as m,dc as g,ec as j,ia as D,ja as w,jb as f,kb as v,na as I,nb as U,ob as F,pb as b,qb as o,ra as c,rb as a,xb as k}from"./chunk-VXUXNVNJ.js";var A=(function(t){return t.User="user",t.Admin="admin",t})(A||{});var Q=(()=>{class t{transform(e,i){let n=parseFloat(e.replace(/,/g,""));return i===void 0||i<=0?n:Math.round(n*(1-i/100))}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=h({name:"discountedCost",type:t,pure:!0})}return t})();var J=[{value:1e15,suffix:"Q"},{value:1e12,suffix:"T"},{value:1e9,suffix:"B"},{value:1e6,suffix:"M"},{value:1e3,suffix:"K"}],X=(()=>{class t{transform(e){let i=typeof e=="string"?parseFloat(e.replace(/,/g,"")):e;if(isNaN(i))return String(e);for(let{value:n,suffix:y}of J)if(i>=n)return`${(i/n).toFixed(2).replace(/\.?0+$/,"")}${y}`;return i.toLocaleString()}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=h({name:"readableNumber",type:t,pure:!0})}return t})();var G=(()=>{class t{http=m(W);environment=m($);localStorage=m(K);url=`${this.environment.api}/coin-master`;villageLevelKey="coin-master-village-level";getVillageCosts(){return this.http.get(`${this.url}/village-cost`)}refreshVillageCosts(){return this.http.post(`${this.url}/refresh-village-cost`,{})}getVillageLevel(){let e=this.localStorage.get(this.villageLevelKey);if(e===void 0)return;let i=parseInt(e,10);return isNaN(i)?void 0:i}setVillageLevel(e){e===void 0?this.localStorage.remove(this.villageLevelKey):this.localStorage.set(this.villageLevelKey,e.toString())}static \u0275fac=function(i){return new(i||t)};static \u0275prov=R({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var Y=(t,r)=>r.level;function Z(t,r){if(t&1){let e=k();o(0,"ps-button",10),B("clicked",function(){D(e);let n=p();return w(n.refreshVillages())}),s(1," Refresh "),a()}if(t&2){let e=p();b("loading",e.isRefreshing())}}function ee(t,r){t&1&&(o(0,"div",7)(1,"span",11),s(2,"Loading villages..."),a()())}function te(t,r){t&1&&s(0," Refresh. ")}function ie(t,r){if(t&1&&(o(0,"div",8)(1,"span",11),s(2,"No villages available. "),f(3,te,1,0),a()()),t&2){let e=p();l(3),v(e.isAdmin()?3:-1)}}function ne(t,r){if(t&1&&(o(0,"div",20)(1,"span",21),s(2),x(3,"readableNumber"),a(),o(4,"span",22),s(5),x(6,"discountedCost"),x(7,"readableNumber"),a()()),t&2){let e=p().$implicit,i=p(2);l(2),u(" ",_(3,2,e.cost)," "),l(3),u(" ",_(7,7,E(6,4,e.cost,i.discountPercentage()))," ")}}function ae(t,r){if(t&1&&(s(0),x(1,"readableNumber")),t&2){let e=p().$implicit;u(" ",_(1,1,e.cost)," ")}}function oe(t,r){if(t&1&&(o(0,"tr",17)(1,"td",18),s(2),a(),o(3,"td",18),s(4),a(),o(5,"td",19),f(6,ne,8,9,"div",20)(7,ae,2,3),a()()),t&2){let e=r.$implicit,i=p(2);H("bg-green-100",e.level===i.nextVillageLevel())("hover:bg-gray-50",e.level!==i.nextVillageLevel())("hover:bg-green-200",e.level===i.nextVillageLevel()),l(2),u(" ",e.level," "),l(2),u(" ",e.name," "),l(2),v(i.hasDiscount()?6:7)}}function se(t,r){if(t&1&&(o(0,"div",9)(1,"table",12)(2,"thead")(3,"tr",13)(4,"th",14),s(5," Level "),a(),o(6,"th",14),s(7," Name "),a(),o(8,"th",15),s(9," Cost "),a()()(),o(10,"tbody"),U(11,oe,8,9,"tr",16,Y),a()()()),t&2){let e=p();l(11),F(e.filteredVillages())}}var Ie=(()=>{class t{authStore=m(z);coinMasterService=m(G);destroyRef=m(I);villages=c([]);isLoading=c(!1);isRefreshing=c(!1);currentLevel=c(this.coinMasterService.getVillageLevel());discountPercentage=c(void 0);persistLevelEffect=j(()=>{this.coinMasterService.setVillageLevel(this.currentLevel())});isAdmin=g(()=>this.authStore.roles().includes(A.Admin));hasNoVillages=g(()=>this.villages().length===0);filteredVillages=g(()=>{let e=this.currentLevel(),i=this.villages();return e===void 0||e<1?i:i.filter(n=>n.level>e)});nextVillageLevel=g(()=>{let e=this.currentLevel();return e===void 0||e<1?null:e+1});hasDiscount=g(()=>{let e=this.discountPercentage();return e!==void 0&&e>0&&e<=100});ngOnInit(){this.loadVillages()}refreshVillages(){this.isRefreshing.set(!0),this.coinMasterService.refreshVillageCosts().pipe(N(()=>this.coinMasterService.getVillageCosts()),C(()=>this.isRefreshing.set(!1)),V(this.destroyRef)).subscribe(e=>this.villages.set(e))}loadVillages(){this.isLoading.set(!0),this.coinMasterService.getVillageCosts().pipe(C(()=>this.isLoading.set(!1)),V(this.destroyRef)).subscribe(e=>this.villages.set(e))}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=P({type:t,selectors:[["ps-coin-master-app"]],decls:11,vars:7,consts:[[1,"@sm:gap-4","@sm:p-4","flex","h-full","w-full","flex-col","gap-2","p-2"],[1,"flex","items-center","justify-between"],[1,"@sm:text-xl","text-lg","font-bold"],["data-testid","refreshButton","variant","secondary","size","sm",3,"loading"],[1,"@sm:gap-4","flex","flex-wrap","gap-2"],["data-testid","levelInput","placeholder","Current level","type","integer",3,"valueChange","min","value"],["data-testid","discountInput","placeholder","Discount %","type","integer",3,"valueChange","min","max","value"],["data-testid","loadingState",1,"flex","flex-1","items-center","justify-center"],["data-testid","emptyState",1,"flex","flex-1","flex-col","items-center","justify-center","gap-2"],[1,"min-h-0","flex-1","overflow-auto"],["data-testid","refreshButton","variant","secondary","size","sm",3,"clicked","loading"],[1,"text-gray-500"],["data-testid","villagesTable",1,"w-full","border-collapse"],[1,"border-b-2","border-gray-300","bg-gray-100"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-left","text-sm","font-semibold"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-right","text-sm","font-semibold"],[1,"border-b","border-gray-200",3,"bg-green-100","hover:bg-gray-50","hover:bg-green-200"],[1,"border-b","border-gray-200"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-sm"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-right","font-mono","text-sm"],[1,"flex","flex-col","items-end"],[1,"text-sm","text-gray-400","line-through"],[1,"font-semibold","text-green-600"]],template:function(i,n){i&1&&(o(0,"div",0)(1,"div",1)(2,"h1",2),s(3,"Village Costs"),a(),f(4,Z,2,1,"ps-button",3),a(),o(5,"div",4)(6,"ps-input",5),L("valueChange",function(d){return M(n.currentLevel,d)||(n.currentLevel=d),d}),a(),o(7,"ps-input",6),L("valueChange",function(d){return M(n.discountPercentage,d)||(n.discountPercentage=d),d}),a()(),f(8,ee,3,0,"div",7)(9,ie,4,1,"div",8)(10,se,13,0,"div",9),a()),i&2&&(l(4),v(n.isAdmin()?4:-1),l(2),b("min",1),S("value",n.currentLevel),l(),b("min",0)("max",100),S("value",n.discountPercentage),l(),v(n.isLoading()?8:n.hasNoVillages()?9:10))},dependencies:[q,O,Q,X],encapsulation:2,changeDetection:0})}return t})();export{Ie as CoinMasterAppComponent};
