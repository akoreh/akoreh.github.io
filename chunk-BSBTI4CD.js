import{a as x,b as M,c as O,e as a,f as J,g as L,h as $,i as F,j as W}from"./chunk-ZNY4EBEK.js";import{a as K,b as V,e as y}from"./chunk-2W377MUZ.js";import{E as I,G as g,J as E,R as v,U as S,Z as c,_ as R,_a as b,a as u,aa as A,b as p,da as s,dc as j,j as w,q as m,ra as N,u as k}from"./chunk-VXUXNVNJ.js";var D={api:"https://api.akoreh.com/api/v1"};var f=new A("ENVIRONMENT");function _(){return{provide:f,useValue:D}}var P=(()=>{class r{notificationsSignal=N([]);notifications=j(()=>this.notificationsSignal());show(t,e={}){let o=this.generateId(),n={id:o,message:t,type:e.type??"default",title:e.title,icon:e.icon};return this.notificationsSignal.update(h=>[n,...h]),o}showDefault(t,e={}){return this.show(t,p(u({},e),{type:"default"}))}showError(t,e={}){return this.show(t,p(u({},e),{type:"error"}))}dismiss(t){this.notificationsSignal.update(e=>e.filter(o=>o.id!==t))}dismissAll(){this.notificationsSignal.set([])}generateId(){return`notification-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}static \u0275fac=function(e){return new(e||r)};static \u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var H=(()=>{class r{get(t){let e=window.localStorage.getItem(t);if(e)return this.isStringifiedJson(e)?JSON.parse(e):e}set(t,e){if(K(e)){let o=JSON.stringify(e);window.localStorage.setItem(t,o)}else window.localStorage.setItem(t,e)}remove(t){window.localStorage.removeItem(t)}isStringifiedJson(t){if(typeof t!="string")return!1;try{let e=JSON.parse(t);return Object.prototype.toString.call(e)==="[object Object]"}catch(e){return V(e),!1}}static \u0275fac=function(e){return new(e||r)};static \u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var l=(()=>{class r{http=s(M);localStorageService=s(H);environment=s(f);get url(){return`${this.environment.api}/auth`}storageKeys={accessToken:"accessToken",refreshToken:"refreshToken"};login(t){return k(this.http.post(`${this.url}/login`,t).pipe(S(e=>this.storeTokens(e))))}register(t){return k(this.http.post(`${this.url}/register`,t).pipe(S(e=>this.storeTokens(e))))}logout(){this.localStorageService.remove(this.storageKeys.accessToken),this.localStorageService.remove(this.storageKeys.refreshToken)}getAccessToken(){return this.localStorageService.get(this.storageKeys.accessToken)||null}getRefreshToken(){return this.localStorageService.get(this.storageKeys.refreshToken)||null}refreshAccessToken(){let t=this.getRefreshToken();return this.http.post(`${this.url}/refresh`,{refreshToken:t}).pipe(S(e=>this.storeTokens(e)))}decodeJWT(t){try{let e=t.split(".");if(e.length!==3)throw new Error("Invalid JWT token format");let o=e[1],n=o+"===".slice((o.length+3)%4),h=atob(n);return JSON.parse(h)}catch(e){throw new Error(`Failed to decode JWT token: ${e instanceof Error?e.message:"Unknown error"}`)}}isJWTExpired(t){try{let e=this.decodeJWT(t);return e.exp?Date.now()>=e.exp*1e3:!1}catch{return!0}}storeTokens({accessToken:t,refreshToken:e}){this.localStorageService.set(this.storageKeys.accessToken,t),this.localStorageService.set(this.storageKeys.refreshToken,e)}static \u0275fac=function(e){return new(e||r)};static \u0275prov=c({token:r,factory:r.\u0275fac})}return r})();var z="Something went wrong. Please try again.";function C(r){if(r instanceof x){let i=r.error;if(i?.errorMessage)return i.errorMessage}return z}var B={accessToken:null,refreshToken:null,userId:null,email:null,roles:[],isAuthenticated:!1,isLoading:!1,error:null},d=J({},W(B),L(()=>({authService:s(l),notificationService:s(P)})),F(r=>({setAccessToken(i){try{let t=r.authService.decodeJWT(i);a(r,{accessToken:i,userId:t.userId,email:t.email,roles:t.roles??[],isAuthenticated:!y(i)})}catch{a(r,{accessToken:i,roles:[],isAuthenticated:!y(i)})}},setRefreshToken(i){a(r,t=>p(u({},t),{refreshToken:i}))},async login(i){a(r,{isLoading:!0,error:null});try{let{accessToken:t,refreshToken:e,user:o}=await r.authService.login(i);a(r,{accessToken:t,refreshToken:e,userId:o.id,email:o.email,roles:o.roles??[],isAuthenticated:!0,isLoading:!1}),r.notificationService.show(`Welcome back, ${o.email}!`,{title:"Signed In",icon:"key"})}catch(t){let e=C(t);a(r,{isLoading:!1,error:e})}},async register(i){a(r,{isLoading:!0,error:null});try{let{accessToken:t,refreshToken:e,user:o}=await r.authService.register(i);a(r,{accessToken:t,refreshToken:e,userId:o.id,email:o.email,roles:o.roles??[],isAuthenticated:!0,isLoading:!1})}catch(t){let e=C(t);a(r,{isLoading:!1,error:e})}},clearError(){a(r,{error:null})},logout(){r.authService.logout(),a(r,B)}})),$({onInit(r){let i=s(l),t=i.getAccessToken(),e=i.getRefreshToken();t&&r.setAccessToken(t),e&&r.setRefreshToken(e)}}));var U=(()=>{class r{authService=s(l);authStore=s(d);environment=s(f);isRefreshing=!1;refreshTokenSubject=new w(null);intercept(t,e){if(!t.url.startsWith(this.environment.api))return e.handle(t);let o=this.addTokenToRequest(t);return e.handle(o).pipe(g(n=>n.status===401&&!t.url.includes("/auth/")?this.handle401Error(t,e):m(()=>n)))}handle401Error(t,e){return this.isRefreshing?this.refreshTokenSubject.pipe(I(o=>o!==null),E(1),v(o=>e.handle(this.addTokenToRequest(t,o)))):(this.isRefreshing=!0,this.refreshTokenSubject.next(null),this.authService.getRefreshToken()?this.authService.refreshAccessToken().pipe(g(n=>(this.isRefreshing=!1,this.authStore.logout(),m(()=>n))),v(({accessToken:n})=>(this.isRefreshing=!1,this.refreshTokenSubject.next(n),this.authStore.setAccessToken(n),e.handle(this.addTokenToRequest(t,n)).pipe(g(h=>(h.status===401&&this.authStore.logout(),m(()=>h))))))):(this.isRefreshing=!1,this.authStore.logout(),m(()=>new Error("No refresh token available"))))}addTokenToRequest(t,e){let o=e??this.authService.getAccessToken();return o?t.clone({setHeaders:{Authorization:`Bearer ${o}`}}):t}static \u0275fac=function(e){return new(e||r)};static \u0275prov=c({token:r,factory:r.\u0275fac})}return r})();var G=(()=>{class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=b({type:r});static \u0275inj=R({providers:[l,d,{provide:O,useClass:U,multi:!0}]})}return r})();export{f as a,_ as b,H as c,P as d,d as e,G as f};
