import{a as J,h as W,i as X,l as Y}from"./chunk-WSO2QVS5.js";import{a as h}from"./chunk-HE5FO3M6.js";import{c as se,d as E}from"./chunk-KXTMMWLN.js";import{a as F}from"./chunk-QHARAMKU.js";import"./chunk-4Z7WS5KL.js";import{f as Q}from"./chunk-5RVANUM6.js";import{a as Z}from"./chunk-VMZW6L7S.js";import{f as z}from"./chunk-NJPGD756.js";import{$b as O,Cb as g,Eb as c,I as N,L as D,La as a,Ob as l,P,Qb as f,S as k,Wb as K,X as j,Zb as _,_a as L,_b as V,ba as p,bb as R,dc as v,e as oe,fc as w,ga as b,gc as q,ha as M,i as T,lb as C,ma as S,mb as x,p as G,pb as H,qb as B,rb as d,sa as u,sb as s,tb as o,zb as I}from"./chunk-G7STBN2K.js";var $=(function(t){return t.User="user",t.Admin="admin",t})($||{});var U=oe(se());var ee=(()=>{class t{level=q(void 0);levelChange=w();discountChange=w();levelChange$=new T;discountChange$=new T;destroyRef=p(S);ngOnInit(){this.levelChange$.pipe(N(300),h(this.destroyRef)).subscribe({next:e=>this.levelChange.emit(e)}),this.discountChange$.pipe(N(300),h(this.destroyRef)).subscribe({next:e=>this.discountChange.emit(e)})}onLevelChange(e){(0,U.isNil)(e)||F(e)?this.levelChange$.next(void 0):this.levelChange$.next(e)}onDiscountChange(e){(0,U.isNil)(e)||F(e)?this.discountChange$.next(void 0):this.discountChange$.next(e)}ngOnDestroy(){this.levelChange$.complete(),this.discountChange$.complete()}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=L({type:t,selectors:[["ps-coin-master-filters"]],inputs:{level:[1,"level"]},outputs:{levelChange:"levelChange",discountChange:"discountChange"},decls:3,vars:4,consts:[[1,"flex","flex-wrap","gap-2","@sm:gap-4"],["data-testid","levelInput","placeholder","Current level","type","integer",3,"valueChange","min","value"],["data-testid","discountInput","placeholder","Discount %","type","integer",3,"valueChange","min","max"]],template:function(i,n){i&1&&(s(0,"div",0)(1,"ps-input",1),g("valueChange",function(y){return n.onLevelChange(y)}),o(),s(2,"ps-input",2),g("valueChange",function(y){return n.onDiscountChange(y)}),o()()),i&2&&(a(),d("min",1)("value",n.level()),a(),d("min",0)("max",100))},dependencies:[E],encapsulation:2,changeDetection:0})}return t})();var te=(()=>{class t{transform(e,i){let n=parseFloat(e.replace(/,/g,""));return i===void 0||i<=0?n:Math.round(n*(1-i/100))}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=R({name:"discountedCost",type:t,pure:!0})}return t})();var ae=[{value:1e15,suffix:"Q"},{value:1e12,suffix:"T"},{value:1e9,suffix:"B"},{value:1e6,suffix:"M"},{value:1e3,suffix:"K"}],ie=(()=>{class t{transform(e){let i=typeof e=="string"?parseFloat(e.replace(/,/g,"")):e;if(isNaN(i))return String(e);for(let{value:n,suffix:m}of ae)if(i>=n)return`${(i/n).toFixed(2).replace(/\.?0+$/,"")}${m}`;return i.toLocaleString()}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=R({name:"readableNumber",type:t,pure:!0})}return t})();var ne=(()=>{class t{http=p(J);environment=p(X);localStorage=p(W);url=`${this.environment.api}/coin-master`;villageLevelKey="coin-master-village-level";villageCostsCache=null;getVillageCosts(){return this.villageCostsCache?G(this.villageCostsCache):this.http.get(`${this.url}/village-cost`).pipe(k(e=>this.villageCostsCache=e))}refreshVillageCosts(){return this.villageCostsCache=null,this.http.post(`${this.url}/refresh-village-cost`,{})}getStoredVillageLevel(){let e=this.localStorage.get(this.villageLevelKey);if(e===void 0)return;let i=parseInt(e,10);return isNaN(i)?void 0:i}storeVillageLevel(e){Q(e)?this.localStorage.remove(this.villageLevelKey):this.localStorage.set(this.villageLevelKey,e.toString())}static \u0275fac=function(i){return new(i||t)};static \u0275prov=j({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var le=(t,r)=>({"bg-green-100 hover:bg-green-200":t,"hover:bg-gray-50":r}),re=(t,r)=>r.level;function ce(t,r){if(t&1){let e=I();s(0,"ps-button",6),g("clicked",function(){b(e);let n=c();return M(n.refreshVillages())}),l(1," Refresh "),o()}if(t&2){let e=c();d("loading",e.isRefreshing())}}function pe(t,r){t&1&&(s(0,"div",4)(1,"span",7),l(2,"Loading villages..."),o()())}function me(t,r){t&1&&l(0," Refresh. ")}function de(t,r){if(t&1&&(s(0,"div",5)(1,"span",7),l(2,"No villages available. "),C(3,me,1,0),o()()),t&2){let e=c();a(3),x(e.isAdmin()?3:-1)}}function ue(t,r){if(t&1&&(s(0,"div",18)(1,"span",19),l(2),_(3,"readableNumber"),o(),s(4,"span",20),l(5),_(6,"discountedCost"),_(7,"readableNumber"),o()()),t&2){let e=c().$implicit,i=c(2);a(2),f(" ",V(3,2,e.cost)," "),a(3),f(" ",V(7,7,O(6,4,e.cost,i.discountPercentage()))," ")}}function ge(t,r){if(t&1&&(l(0),_(1,"readableNumber")),t&2){let e=c().$implicit;f(" ",V(1,1,e.cost)," ")}}function fe(t,r){if(t&1&&(s(0,"tr",15)(1,"td",16),l(2),o(),s(3,"td",16),l(4),o(),s(5,"td",17),C(6,ue,8,9,"div",18)(7,ge,2,3),o()()),t&2){let e=r.$implicit,i=c(2);d("ngClass",K(4,le,e.level===i.currentLevel(),e.level!==i.currentLevel())),a(2),f(" ",e.level," "),a(2),f(" ",e.name," "),a(2),x(i.hasDiscount()?6:7)}}function ve(t,r){if(t&1){let e=I();s(0,"div",8)(1,"ps-coin-master-filters",9),g("levelChange",function(n){b(e);let m=c();return M(m.onLevelChange(n))})("discountChange",function(n){b(e);let m=c();return M(m.discountPercentage.set(n))}),o()(),s(2,"div",10)(3,"table",11)(4,"thead")(5,"tr",12)(6,"th",13),l(7," Level "),o(),s(8,"th",13),l(9," Name "),o(),s(10,"th",14),l(11," Cost "),o()()(),s(12,"tbody"),H(13,fe,8,7,"tr",15,re),o()()()}if(t&2){let e=c();a(),d("level",e.currentLevel()),a(12),B(e.filteredVillages())}}var et=(()=>{class t{authStore=p(Y);coinMasterService=p(ne);destroyRef=p(S);villages=u([]);isLoading=u(!1);isRefreshing=u(!1);currentLevel=u(this.coinMasterService.getStoredVillageLevel());discountPercentage=u(void 0);isAdmin=v(()=>this.authStore.roles().includes($.Admin));hasNoVillages=v(()=>this.villages().length===0);filteredVillages=v(()=>{let e=this.currentLevel(),i=this.villages();return e===void 0||e<1?i:i.filter(n=>n.level>=e)});nextVillageLevel=v(()=>{let e=this.currentLevel();return e===void 0||e<1?null:e+1});hasDiscount=v(()=>{let e=this.discountPercentage();return e!==void 0&&e>0&&e<=100});ngOnInit(){this.loadVillages()}onLevelChange(e){this.currentLevel.set(e),this.coinMasterService.storeVillageLevel(e)}refreshVillages(){this.isRefreshing.set(!0),this.coinMasterService.refreshVillageCosts().pipe(P(()=>this.coinMasterService.getVillageCosts()),D(()=>this.isRefreshing.set(!1)),h(this.destroyRef)).subscribe(e=>this.villages.set(e))}loadVillages(){this.isLoading.set(!0),this.coinMasterService.getVillageCosts().pipe(D(()=>this.isLoading.set(!1)),h(this.destroyRef)).subscribe(e=>this.villages.set(e))}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=L({type:t,selectors:[["ps-coin-master-app"]],decls:8,vars:2,consts:[[1,"flex","h-full","w-full","flex-col","gap-2","p-2","@sm:gap-4","@sm:p-4"],[1,"flex","items-center","justify-between"],[1,"text-lg","font-bold","@sm:text-xl"],["data-testid","refreshButton","variant","secondary","size","sm",3,"loading"],["data-testid","loadingState",1,"flex","flex-1","items-center","justify-center"],["data-testid","emptyState",1,"flex","flex-1","flex-col","items-center","justify-center","gap-2"],["data-testid","refreshButton","variant","secondary","size","sm",3,"clicked","loading"],[1,"text-gray-500"],[1,"flex","w-full","justify-center"],[3,"levelChange","discountChange","level"],[1,"mt-6","min-h-0","flex-1","overflow-auto"],["data-testid","villagesTable",1,"w-full","border-collapse"],[1,"border-b-2","border-gray-300","bg-gray-100"],[1,"px-2","py-1","text-left","text-sm","font-semibold","@sm:px-4","@sm:py-2","@sm:text-base"],[1,"px-2","py-1","text-right","text-sm","font-semibold","@sm:px-4","@sm:py-2","@sm:text-base"],[1,"border-b","border-gray-200",3,"ngClass"],[1,"px-2","py-1","text-sm","@sm:px-4","@sm:py-2","@sm:text-base"],[1,"px-2","py-1","text-right","font-mono","text-sm","@sm:px-4","@sm:py-2","@sm:text-base"],[1,"flex","flex-col","items-end"],[1,"text-sm","text-gray-400","line-through"],[1,"font-semibold","text-green-600"]],template:function(i,n){i&1&&(s(0,"div",0)(1,"div",1)(2,"h1",2),l(3,"Village Costs"),o(),C(4,ce,2,1,"ps-button",3),o(),C(5,pe,3,0,"div",4)(6,de,4,1,"div",5)(7,ve,15,1),o()),i&2&&(a(4),x(n.isAdmin()?4:-1),a(),x(n.isLoading()?5:n.hasNoVillages()?6:7))},dependencies:[Z,z,ee,te,ie],encapsulation:2,changeDetection:0})}return t})();export{et as CoinMasterAppComponent};
