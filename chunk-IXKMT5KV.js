import{a as Q,c as W,e as X}from"./chunk-HS34P2VP.js";import{b as O}from"./chunk-HMKHSG36.js";import{a as h}from"./chunk-YXZGUZVC.js";import{c as ne,d as J}from"./chunk-O4TYAFWO.js";import{a as I}from"./chunk-XJ6YCN2L.js";import"./chunk-2L7GPSYA.js";import{f as q}from"./chunk-3LM2PHH3.js";import{a as G}from"./chunk-CXCGOA47.js";import{e as z}from"./chunk-Q2JNIJVH.js";import{$b as _,Ab as w,Db as g,Fb as p,K as N,La as l,O as R,Pb as a,Rb as f,U as P,Xb as E,aa as k,ab as V,ac as A,bc as B,db as T,e as ie,ga as c,gc as v,jc as F,k as D,kc as K,la as y,ma as M,mb as x,nb as C,qa as S,qb as H,rb as j,sb as d,tb as s,ua as u,ub as o}from"./chunk-YYXXHZ7Z.js";var $=(function(t){return t.User="user",t.Admin="admin",t})($||{});var U=ie(ne());var Y=(()=>{class t{level=K(void 0);levelChange=F();discountChange=F();levelChange$=new D;discountChange$=new D;destroyRef=c(S);ngOnInit(){this.levelChange$.pipe(N(300),h(this.destroyRef)).subscribe({next:e=>this.levelChange.emit(e)}),this.discountChange$.pipe(N(300),h(this.destroyRef)).subscribe({next:e=>this.discountChange.emit(e)})}onLevelChange(e){(0,U.isNil)(e)||I(e)?this.levelChange$.next(void 0):this.levelChange$.next(e)}onDiscountChange(e){(0,U.isNil)(e)||I(e)?this.discountChange$.next(void 0):this.discountChange$.next(e)}ngOnDestroy(){this.levelChange$.complete(),this.discountChange$.complete()}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=V({type:t,selectors:[["ps-coin-master-filters"]],inputs:{level:[1,"level"]},outputs:{levelChange:"levelChange",discountChange:"discountChange"},decls:3,vars:4,consts:[[1,"@sm:gap-4","flex","flex-wrap","gap-2"],["data-testid","levelInput","placeholder","Current level","type","integer",3,"valueChange","min","value"],["data-testid","discountInput","placeholder","Discount %","type","integer",3,"valueChange","min","max"]],template:function(i,n){i&1&&(s(0,"div",0)(1,"ps-input",1),g("valueChange",function(b){return n.onLevelChange(b)}),o(),s(2,"ps-input",2),g("valueChange",function(b){return n.onDiscountChange(b)}),o()()),i&2&&(l(),d("min",1)("value",n.level()),l(),d("min",0)("max",100))},dependencies:[J],encapsulation:2,changeDetection:0})}return t})();var Z=(()=>{class t{transform(e,i){let n=parseFloat(e.replace(/,/g,""));return i===void 0||i<=0?n:Math.round(n*(1-i/100))}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=T({name:"discountedCost",type:t,pure:!0})}return t})();var oe=[{value:1e15,suffix:"Q"},{value:1e12,suffix:"T"},{value:1e9,suffix:"B"},{value:1e6,suffix:"M"},{value:1e3,suffix:"K"}],ee=(()=>{class t{transform(e){let i=typeof e=="string"?parseFloat(e.replace(/,/g,"")):e;if(isNaN(i))return String(e);for(let{value:n,suffix:m}of oe)if(i>=n)return`${(i/n).toFixed(2).replace(/\.?0+$/,"")}${m}`;return i.toLocaleString()}static \u0275fac=function(i){return new(i||t)};static \u0275pipe=T({name:"readableNumber",type:t,pure:!0})}return t})();var te=(()=>{class t{http=c(O);environment=c(Q);localStorage=c(W);url=`${this.environment.api}/coin-master`;villageLevelKey="coin-master-village-level";getVillageCosts(){return this.http.get(`${this.url}/village-cost`)}refreshVillageCosts(){return this.http.post(`${this.url}/refresh-village-cost`,{})}getStoredVillageLevel(){let e=this.localStorage.get(this.villageLevelKey);if(e===void 0)return;let i=parseInt(e,10);return isNaN(i)?void 0:i}storeVillageLevel(e){q(e)?this.localStorage.remove(this.villageLevelKey):this.localStorage.set(this.villageLevelKey,e.toString())}static \u0275fac=function(i){return new(i||t)};static \u0275prov=k({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var se=(t,r)=>({"bg-green-100 hover:bg-green-200":t,"hover:bg-gray-50":r}),ae=(t,r)=>r.level;function le(t,r){if(t&1){let e=w();s(0,"ps-button",6),g("clicked",function(){y(e);let n=p();return M(n.refreshVillages())}),a(1," Refresh "),o()}if(t&2){let e=p();d("loading",e.isRefreshing())}}function re(t,r){t&1&&(s(0,"div",4)(1,"span",7),a(2,"Loading villages..."),o()())}function pe(t,r){t&1&&a(0," Refresh. ")}function ce(t,r){if(t&1&&(s(0,"div",5)(1,"span",7),a(2,"No villages available. "),x(3,pe,1,0),o()()),t&2){let e=p();l(3),C(e.isAdmin()?3:-1)}}function me(t,r){if(t&1&&(s(0,"div",17)(1,"span",18),a(2),_(3,"readableNumber"),o(),s(4,"span",19),a(5),_(6,"discountedCost"),_(7,"readableNumber"),o()()),t&2){let e=p().$implicit,i=p(2);l(2),f(" ",A(3,2,e.cost)," "),l(3),f(" ",A(7,7,B(6,4,e.cost,i.discountPercentage()))," ")}}function de(t,r){if(t&1&&(a(0),_(1,"readableNumber")),t&2){let e=p().$implicit;f(" ",A(1,1,e.cost)," ")}}function ue(t,r){if(t&1&&(s(0,"tr",14)(1,"td",15),a(2),o(),s(3,"td",15),a(4),o(),s(5,"td",16),x(6,me,8,9,"div",17)(7,de,2,3),o()()),t&2){let e=r.$implicit,i=p(2);d("ngClass",E(4,se,e.level===i.currentLevel(),e.level!==i.currentLevel())),l(2),f(" ",e.level," "),l(2),f(" ",e.name," "),l(2),C(i.hasDiscount()?6:7)}}function ge(t,r){if(t&1){let e=w();s(0,"ps-coin-master-filters",8),g("levelChange",function(n){y(e);let m=p();return M(m.onLevelChange(n))})("discountChange",function(n){y(e);let m=p();return M(m.discountPercentage.set(n))}),o(),s(1,"div",9)(2,"table",10)(3,"thead")(4,"tr",11)(5,"th",12),a(6," Level "),o(),s(7,"th",12),a(8," Name "),o(),s(9,"th",13),a(10," Cost "),o()()(),s(11,"tbody"),H(12,ue,8,7,"tr",14,ae),o()()()}if(t&2){let e=p();d("level",e.currentLevel()),l(12),j(e.filteredVillages())}}var Je=(()=>{class t{authStore=c(X);coinMasterService=c(te);destroyRef=c(S);villages=u([]);isLoading=u(!1);isRefreshing=u(!1);currentLevel=u(this.coinMasterService.getStoredVillageLevel());discountPercentage=u(void 0);isAdmin=v(()=>this.authStore.roles().includes($.Admin));hasNoVillages=v(()=>this.villages().length===0);filteredVillages=v(()=>{let e=this.currentLevel(),i=this.villages();return e===void 0||e<1?i:i.filter(n=>n.level>=e)});nextVillageLevel=v(()=>{let e=this.currentLevel();return e===void 0||e<1?null:e+1});hasDiscount=v(()=>{let e=this.discountPercentage();return e!==void 0&&e>0&&e<=100});ngOnInit(){this.loadVillages()}onLevelChange(e){this.currentLevel.set(e),this.coinMasterService.storeVillageLevel(e)}refreshVillages(){this.isRefreshing.set(!0),this.coinMasterService.refreshVillageCosts().pipe(P(()=>this.coinMasterService.getVillageCosts()),R(()=>this.isRefreshing.set(!1)),h(this.destroyRef)).subscribe(e=>this.villages.set(e))}loadVillages(){this.isLoading.set(!0),this.coinMasterService.getVillageCosts().pipe(R(()=>this.isLoading.set(!1)),h(this.destroyRef)).subscribe(e=>this.villages.set(e))}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=V({type:t,selectors:[["ps-coin-master-app"]],decls:8,vars:2,consts:[[1,"@sm:gap-4","@sm:p-4","flex","h-full","w-full","flex-col","gap-2","p-2"],[1,"flex","items-center","justify-between"],[1,"@sm:text-xl","text-lg","font-bold"],["data-testid","refreshButton","variant","secondary","size","sm",3,"loading"],["data-testid","loadingState",1,"flex","flex-1","items-center","justify-center"],["data-testid","emptyState",1,"flex","flex-1","flex-col","items-center","justify-center","gap-2"],["data-testid","refreshButton","variant","secondary","size","sm",3,"clicked","loading"],[1,"text-gray-500"],[3,"levelChange","discountChange","level"],[1,"mt-6","min-h-0","flex-1","overflow-auto"],["data-testid","villagesTable",1,"w-full","border-collapse"],[1,"border-b-2","border-gray-300","bg-gray-100"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-left","text-sm","font-semibold"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-right","text-sm","font-semibold"],[1,"border-b","border-gray-200",3,"ngClass"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-sm"],[1,"@sm:px-4","@sm:py-2","@sm:text-base","px-2","py-1","text-right","font-mono","text-sm"],[1,"flex","flex-col","items-end"],[1,"text-sm","text-gray-400","line-through"],[1,"font-semibold","text-green-600"]],template:function(i,n){i&1&&(s(0,"div",0)(1,"div",1)(2,"h1",2),a(3,"Village Costs"),o(),x(4,le,2,1,"ps-button",3),o(),x(5,re,3,0,"div",4)(6,ce,4,1,"div",5)(7,ge,14,1),o()),i&2&&(l(4),C(n.isAdmin()?4:-1),l(),C(n.isLoading()?5:n.hasNoVillages()?6:7))},dependencies:[G,z,Y,Z,ee],encapsulation:2,changeDetection:0})}return t})();export{Je as CoinMasterAppComponent};
